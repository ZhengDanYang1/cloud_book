# 第2节：分布式事物系统

随着分布计算技术的发展，分布应用系统对大规模的事务处理提出了较为苛刻的需求，比如商业活动中大量的关键事务处理。事务处理监控界于Client和Server之间，进行事务管理与协调、负载平衡、失败恢复等，以提高系统的整体性能。分布式事务系统中间件适用于联机交易处理系统，主要功能是管理分布于不同计算机上的数据的一致性，保障系统处理能力的效率与均衡负载。

业界著名的CAP理论告诉我们，在设计和实现一个分布式系统时，需要将数据一致性、系统可用性和分区容忍性放在一起考虑。而在分布式系统中，一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance）这3 个要素最多只能同时满足两个，不可兼顾。一致性是指分布式环境下多个节点的数据是否强一致。可用性是指分布式服务能一直保证可用状态。当用户发出一个请求后，服务能在有限时间内返回结果。而分区容忍性特指对网络分区的容忍性。其中，分区容忍性又是不可或缺的。分布式事务中间件的目的是保障分布式存储中数据一致性，而跨库事务会遇到各种不可控制的问题，如个别节点宕机，像单机事务一样的ACID是无法奢望的。ACID是指：

a)   原子性(Atomic)：事务必须是原子工作单元,对于其修改数据，要么全部成功，要么全部失败。

b)   一致性(Consistent):事务在完成时，必须使所有的数据都保持一致状态。

c)   隔离性(Insulation):由并发事务所作的修改必须与任何其它并发事务所作的修改隔离。

d)   持久性(Duration):事务完成之后，它对于系统的影响是永久性的。

目前主流的分布式事务解决方案有：

a)   TCC-补偿型事务解决方案

TCC指的是Try(尝试)、Confirm（确认）、Cancle（取消）,其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：

- Try 阶段主要是对业务系统做检测及资源预留
- Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。
- Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。

b)   两阶段提交（2PC）

两阶段提交（Two-phase Commit，2PC），通过引入协调者（Coordinator）来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。

c)   本地消息表（异步确保）

- 本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证最终一致性。
- 在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。
- 之后将本地消息表中的消息转发到 Kafka 等消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。
- 在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。

d)   MQ 事务消息

有一些第三方的MQ是支持事务消息的，比如RocketMQ，他们支持事务消息的方式也是类似于采用的二阶段提交，但是市面上一些主流的MQ都是不支持事务消息的，比如 RabbitMQ 和 Kafka 都不支持。